name: Release

on:
    push:
        tags:
            - "v*.*.*"
    workflow_dispatch:
        inputs:
            version:
                description: "Version to release (e.g., v1.0.0)"
                required: true
                type: string

env:
    CARGO_TERM_COLOR: always
    RUST_BACKTRACE: 1
    RELEASES_REPO: k5602/vulnera-releases
    BINARY_NAME: vulnera

jobs:
    build:
        name: Build ${{ matrix.target }}
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - target: x86_64-unknown-linux-gnu
                      os: ubuntu-latest
                      archive: tar.gz
                    - target: x86_64-unknown-linux-musl
                      os: ubuntu-latest
                      archive: tar.gz
                      use-cross: true
                    - target: aarch64-unknown-linux-gnu
                      os: ubuntu-latest
                      archive: tar.gz
                      use-cross: true
                    - target: x86_64-apple-darwin
                      os: macos-13
                      archive: tar.gz
                    - target: aarch64-apple-darwin
                      os: macos-latest
                      archive: tar.gz
                    - target: x86_64-pc-windows-msvc
                      os: windows-latest
                      archive: zip
                      ext: .exe

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Determine version
              id: version
              shell: bash
              run: |
                  if [ -n "${{ github.event.inputs.version }}" ]; then
                    echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
                  else
                    echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
                  fi

            - name: Install Rust
              uses: actions-rust-lang/setup-rust-toolchain@v1
              with:
                  toolchain: stable
                  target: ${{ matrix.target }}

            - name: Install cross
              if: matrix.use-cross
              run: cargo install cross --git https://github.com/cross-rs/cross

            - name: Setup cache
              uses: Swatinem/rust-cache@v2
              with:
                  key: ${{ matrix.target }}

            - name: Build (cross)
              if: matrix.use-cross
              run: cross build --release --target ${{ matrix.target }} --manifest-path vulnera-cli/Cargo.toml

            - name: Build (native)
              if: ${{ !matrix.use-cross }}
              run: cargo build --release --target ${{ matrix.target }} --manifest-path vulnera-cli/Cargo.toml

            - name: Create archive directory
              shell: bash
              run: |
                  mkdir -p dist
                  ARCHIVE_NAME="${BINARY_NAME}-${{ steps.version.outputs.VERSION }}-${{ matrix.target }}"
                  mkdir -p "dist/${ARCHIVE_NAME}"

                  if [ "${{ runner.os }}" = "Windows" ]; then
                    cp "target/${{ matrix.target }}/release/${BINARY_NAME}.exe" "dist/${ARCHIVE_NAME}/"
                  else
                    cp "target/${{ matrix.target }}/release/${BINARY_NAME}" "dist/${ARCHIVE_NAME}/"
                    strip "dist/${ARCHIVE_NAME}/${BINARY_NAME}" 2>/dev/null || true
                  fi

                  cp README.md "dist/${ARCHIVE_NAME}/" 2>/dev/null || true
                  cp LICENSE "dist/${ARCHIVE_NAME}/" 2>/dev/null || true

            - name: Create tar.gz archive
              if: matrix.archive == 'tar.gz'
              shell: bash
              run: |
                  ARCHIVE_NAME="${BINARY_NAME}-${{ steps.version.outputs.VERSION }}-${{ matrix.target }}"
                  cd dist
                  tar -czvf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"
                  rm -rf "${ARCHIVE_NAME}"

            - name: Create zip archive
              if: matrix.archive == 'zip'
              shell: bash
              run: |
                  ARCHIVE_NAME="${BINARY_NAME}-${{ steps.version.outputs.VERSION }}-${{ matrix.target }}"
                  cd dist
                  7z a "${ARCHIVE_NAME}.zip" "${ARCHIVE_NAME}"
                  rm -rf "${ARCHIVE_NAME}"

            - name: Generate checksum
              shell: bash
              run: |
                  cd dist
                  if command -v sha256sum &> /dev/null; then
                    sha256sum * > checksums-${{ matrix.target }}.txt
                  else
                    shasum -a 256 * > checksums-${{ matrix.target }}.txt
                  fi

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: dist-${{ matrix.target }}
                  path: dist/*
                  retention-days: 1
                  if-no-files-found: error

    release:
        name: Publish Release
        needs: build
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Determine version
              id: version
              run: |
                  if [ -n "${{ github.event.inputs.version }}" ]; then
                    echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
                  else
                    echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
                  fi

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Collect release files
              run: |
                  mkdir -p release
                  find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release/ \;

                  cd release
                  cat ../artifacts/*/checksums-*.txt | grep -v "checksums-" > checksums.sha256

                  ls -la

            - name: Generate release notes
              run: |
                  cat > release_notes.md << 'EOF'
                  # Vulnera CLI ${{ steps.version.outputs.VERSION }}

                  ## Installation

                  ### Quick Install (Recommended)

                  ```bash
                  curl -fsSL https://raw.githubusercontent.com/${{ env.RELEASES_REPO }}/main/install.sh | sh
                  ```

                  ### Manual Download

                  Download the appropriate binary for your platform from the assets below.

                  ### Verify Checksum

                  ```bash
                  curl -LO https://github.com/${{ env.RELEASES_REPO }}/releases/download/${{ steps.version.outputs.VERSION }}/checksums.sha256
                  sha256sum -c checksums.sha256 --ignore-missing
                  ```

                  ## Documentation

                  - [Quick Start Guide](https://github.com/k5602/vulnera/blob/main/docs/QUICK_START.md)
                  - [CLI Guide](https://github.com/k5602/vulnera/blob/main/docs/CLI_GUIDE.md)
                  EOF

            - name: Create source release
              uses: softprops/action-gh-release@v2
              with:
                  name: Vulnera CLI ${{ steps.version.outputs.VERSION }}
                  body_path: release_notes.md
                  files: release/*
                  draft: false
                  prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}

            - name: Create public release
              env:
                  GH_TOKEN: ${{ secrets.RELEASES_PAT }}
              run: |
                  VERSION="${{ steps.version.outputs.VERSION }}"

                  gh release delete "$VERSION" --repo "${{ env.RELEASES_REPO }}" --yes 2>/dev/null || true

                  PRERELEASE_FLAG=""
                  if [[ "$VERSION" == *"-"* ]]; then
                    PRERELEASE_FLAG="--prerelease"
                  fi

                  gh release create "$VERSION" \
                    --repo "${{ env.RELEASES_REPO }}" \
                    --title "Vulnera CLI $VERSION" \
                    --notes-file release_notes.md \
                    $PRERELEASE_FLAG \
                    release/*

    update-installer:
        name: Update Installer
        needs: release
        runs-on: ubuntu-latest

        steps:
            - name: Checkout source
              uses: actions/checkout@v4

            - name: Update installer in releases repo
              env:
                  GH_TOKEN: ${{ secrets.RELEASES_PAT }}
              run: |
                  git clone "https://x-access-token:${GH_TOKEN}@github.com/${{ env.RELEASES_REPO }}.git" releases-repo

                  cp install.sh releases-repo/

                  cd releases-repo
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  if git diff --quiet; then
                    echo "No changes to installer"
                  else
                    git add install.sh
                    git commit -m "Update installer script"
                    git push
                  fi
