# Default configuration for Vulnera Rust

[server]
host = "0.0.0.0"
port = 3000
workers = 4
enable_docs = true
request_timeout_seconds = 30
# Per-endpoint timeouts (in seconds) - overrides global request_timeout_seconds
dependencies_analysis_timeout_seconds = 600  # 10 minutes for dependency analysis
general_analysis_timeout_seconds = 90        # 1.5 minutes for general analysis
allowed_origins = []

[server.security]
enforce_https = false
enable_security_headers = false
sanitize_errors = false
hsts_max_age = 31536000         # 1 year in seconds
hsts_include_subdomains = true

[server.rate_limit]
enabled = true
storage_backend = "dragonfly"  # Options: "dragonfly", "memory"
cleanup_interval_seconds = 300

# Tier-based rate limits (token bucket algorithm)
[server.rate_limit.tiers]
org_bonus_percent = 20  # Organization members get 20% bonus on limits

[server.rate_limit.tiers.api_key]
# API key authentication (CLI/Extensions) - highest limits
requests_per_minute = 100
requests_per_hour = 2000
burst_size = 20

[server.rate_limit.tiers.authenticated]
# Cookie-based authentication (web users) - medium limits
requests_per_minute = 60
requests_per_hour = 1000
burst_size = 10

[server.rate_limit.tiers.anonymous]
# Unauthenticated users - lowest limits
requests_per_minute = 10
requests_per_hour = 100
burst_size = 5

# Request cost weights (token consumption per request type)
[server.rate_limit.costs]
get = 1      # Read operations
post = 2     # Write operations
analysis = 3 # Dependency scanning, SAST, etc.
llm = 6    # LLM operations (explanations, code fixes)

# Auth endpoint brute-force protection (sliding window algorithm)
[server.rate_limit.auth_protection]
enabled = true
login_attempts_per_minute = 5
login_attempts_per_hour = 20
register_attempts_per_minute = 3
register_attempts_per_hour = 10
lockout_duration_minutes = 15

[cache]
ttl_hours = 24
l1_cache_size_mb = 100
l1_cache_ttl_seconds = 300
enable_cache_compression = true
compression_threshold_bytes = 10240
# Dragonfly DB configuration
dragonfly_url = "redis://127.0.0.1:6379"
dragonfly_connection_timeout_seconds = 5

[analysis]
max_concurrent_packages = 8
max_concurrent_registry_queries = 10
max_concurrent_api_calls = 12
job_queue_capacity = 64
max_job_workers = 8
# Extension-friendly settings
extension_batch_size_limit = 25    # Max files per batch for extension requests
enable_response_compression = true # Enable gzip compression for responses
cache_extension_results = true     # Cache results for faster repeated analysis

[sync]
# Background vulnerability data synchronization
enabled = true
interval_hours = 8            # Re-sync every 8 hours (GHSA, OSV, NVD)
on_startup = true             # Sync immediately on server start
shutdown_timeout_seconds = 30 # Max wait time for sync task on shutdown

[analytics]
# Usage analytics and statistics tracking
enabled = true
enable_user_level_tracking = true  # Track personal stats for users without orgs
event_retention_days = 180         # Keep analysis events for 6 months
cleanup_interval_hours = 24        # Run cleanup daily
cleanup_on_startup = false         # Don't cleanup on startup (let system stabilize first)

[auth]
# JWT secret key - MUST be set via VULNERA__AUTH__JWT_SECRET environment variable
# The secret should be at least 32 characters long and randomly generated
# Example: openssl rand -hex 32
jwt_secret = "${JWT_SECRET:-MUST_SET_JWT_SECRET_IN_ENVIRONMENT}"
token_ttl_hours = 24
refresh_token_ttl_hours = 720                                    # 30 days
api_key_length = 32
api_key_ttl_days = 365                                           # 1 year, set to null for no expiration

# Cookie-based authentication settings
cookie_domain = ""                  # Empty for localhost, set to your domain in production (e.g., "vulnera.io")
cookie_secure = false               # Set to true in production (requires HTTPS)
cookie_same_site = "lax"            # Options: "strict", "lax", "none" (lax recommended for most use cases)
cookie_path = "/"                   # Path for access token cookie
refresh_cookie_path = "/api/v1/auth/refresh"  # Path for refresh token cookie (restricted to refresh endpoint)
csrf_token_bytes = 32               # Size of CSRF token (256 bits of entropy)
blacklist_tokens_on_logout = true   # Add tokens to blacklist on logout (requires cache)

[database]
# Database connection URL (can also be set via DATABASE_URL env var)
# Override via VULNERA__DATABASE__URL environment variable
url = "postgres://postgres:postgres@localhost/vulnera"
max_connections = 10
min_idle = 2
connect_timeout_seconds = 30
max_lifetime_seconds = 1800
idle_timeout_seconds = 600
enable_health_checks = true

[apis.nvd]
base_url = "https://services.nvd.nist.gov/rest/json"
timeout_seconds = 30
rate_limit_per_30s = 5                               # Without API key, 50 with API key

[apis.ghsa]
graphql_url = "https://api.github.com/graphql"
timeout_seconds = 30
# token = "your_github_token_here"  # Set via environment variable VULNERA__APIS__GHSA__TOKEN

[apis.github]
base_url = "https://api.github.com"
# If unset, server may reuse GHSA token when reuse_ghsa_token=true
token = ""
reuse_ghsa_token = true
timeout_seconds = 30
max_concurrent_file_fetches = 8
max_files_scanned = 200
max_total_bytes = 2000000
max_single_file_bytes = 1000000
backoff_initial_ms = 500
backoff_max_retries = 3
backoff_jitter = true

[logging]
level = "info"
format = "json"

# SAST (Static Application Security Testing) configuration
[sast]
max_scan_depth = 20
exclude_patterns = [
    "node_modules", ".git", "target", "__pycache__",
    ".venv", "venv", "dist", "build", "docs", "doc",
    "examples", "example", "test", "tests", "vendor",
    "third_party", "fixtures"
]
# rule_file_path = "/path/to/custom/rules.toml"  # Optional custom rule file
enable_logging = true
enable_semgrep = false           # Enable Semgrep for taint analysis
semgrep_path = "/usr/local/bin/semgrep"  # Full path to Semgrep binary (can be overridden via VULNERA__SAST__SEMGREP_PATH env var)
semgrep_timeout_secs = 60       # Timeout for Semgrep execution
enable_ast_cache = true         # Enable AST caching via Dragonfly
ast_cache_ttl_hours = 4         # AST cache TTL in hours
max_concurrent_files = 4        # Maximum concurrent file analysis

# Popular packages configuration for vulnerability listing
[popular_packages]
# Cache TTL for popular package vulnerability listings (in hours)
cache_ttl_hours = 24
