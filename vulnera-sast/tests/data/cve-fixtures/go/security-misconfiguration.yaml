# Go Security Misconfiguration
# Covers: TLS skip verify, insecure random, timing attacks, defer in loop
# Rule IDs: go-tls-insecure-skip-verify, go-insecure-rand, go-timing-attack, go-defer-loop

id: "GO-SECURITY-MISC"
name: "Go Security Misconfiguration"
language: "go"
vulnerability_type: "misconfiguration"
severity: "medium"
cwe:
  - "CWE-295"
  - "CWE-338"
  - "CWE-208"
impact: "Weakened TLS, predictable randomness, and timing side-channels"

test_cases:
  # TP: TLS skip verify
  - name: "InsecureSkipVerify set to true"
    vulnerable: true
    code: |
      package main
      import (
          "crypto/tls"
          "net/http"
      )
      func createClient() *http.Client {
          tr := &http.Transport{
              TLSClientConfig: &tls.Config{InsecureSkipVerify: true},
          }
          return &http.Client{Transport: tr}
      }
    expected_findings:
      - rule_id: "go-tls-insecure-skip-verify"

  # TP: insecure random
  - name: "math/rand for token"
    vulnerable: true
    code: |
      package main
      import "math/rand"
      func generateToken() int {
          return rand.Int()
      }
    expected_findings:
      - rule_id: "go-insecure-rand"

  - name: "rand.Intn for secret"
    vulnerable: true
    code: |
      package main
      import (
          "fmt"
          "math/rand"
      )
      func generateCode() string {
          return fmt.Sprintf("%06d", rand.Intn(999999))
      }
    expected_findings:
      - rule_id: "go-insecure-rand"

  # TP: timing attack (string comparison for secrets)
  - name: "string equality for token comparison"
    vulnerable: true
    code: |
      package main
      func verifyToken(provided string, expected string) bool {
          return provided == expected
      }
    expected_findings:
      - rule_id: "go-timing-attack"

  # TP: defer in loop
  - name: "defer inside for loop"
    vulnerable: true
    code: |
      package main
      import "os"
      func processFiles(paths []string) error {
          for _, path := range paths {
              f, err := os.Open(path)
              if err != nil {
                  return err
              }
              defer f.Close()
          }
          return nil
      }
    expected_findings:
      - rule_id: "go-defer-loop"

  # FP: safe alternatives
  - name: "proper TLS configuration (safe)"
    vulnerable: false
    code: |
      package main
      import (
          "crypto/tls"
          "net/http"
      )
      func createClient() *http.Client {
          tr := &http.Transport{
              TLSClientConfig: &tls.Config{MinVersion: tls.VersionTLS12},
          }
          return &http.Client{Transport: tr}
      }

  - name: "crypto/rand for tokens (safe)"
    vulnerable: false
    code: |
      package main
      import (
          "crypto/rand"
          "encoding/hex"
      )
      func generateToken() (string, error) {
          b := make([]byte, 32)
          _, err := rand.Read(b)
          if err != nil {
              return "", err
          }
          return hex.EncodeToString(b), nil
      }

  - name: "constant time comparison (safe)"
    vulnerable: false
    code: |
      package main
      import "crypto/subtle"
      func verifyToken(provided string, expected string) bool {
          return subtle.ConstantTimeCompare([]byte(provided), []byte(expected)) == 1
      }

  - name: "close inside loop body (safe)"
    vulnerable: false
    code: |
      package main
      import "os"
      func processFiles(paths []string) error {
          for _, path := range paths {
              f, err := os.Open(path)
              if err != nil {
                  return err
              }
              data := make([]byte, 1024)
              f.Read(data)
              f.Close()
          }
          return nil
      }

  - name: "math/rand for non-security use (safe)"
    vulnerable: false
    code: |
      package main
      import "math/rand"
      func shuffleColors(colors []string) {
          rand.Shuffle(len(colors), func(i, j int) {
              colors[i], colors[j] = colors[j], colors[i]
          })
      }
