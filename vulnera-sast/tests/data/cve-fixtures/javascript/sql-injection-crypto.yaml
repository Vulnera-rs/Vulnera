# JavaScript SQL Injection & Crypto Weaknesses
# Covers: SQL string concatenation, weak crypto, insecure random
# Rule IDs: js-sql-injection, js-weak-crypto, js-insecure-random

id: "JS-SQL-CRYPTO"
name: "JavaScript SQL Injection & Crypto Weaknesses"
language: "javascript"
vulnerability_type: "injection_and_crypto"
severity: "high"
cwe:
  - "CWE-89"
  - "CWE-327"
  - "CWE-338"
impact: "SQL injection and use of weak cryptographic primitives"

test_cases:
  # TP: SQL injection via template literal
  - name: "SQL query with template literal"
    vulnerable: true
    code: |
      function findUser(id) {
          const query = `SELECT * FROM users WHERE id = ${id}`;
          return db.query(query);
      }
    expected_findings:
      - rule_id: "js-sql-injection"

  - name: "SQL query with string concatenation"
    vulnerable: true
    code: |
      function search(name) {
          const sql = "SELECT * FROM products WHERE name = '" + name + "'";
          return connection.query(sql);
      }
    expected_findings:
      - rule_id: "js-sql-injection"

  # TP: weak crypto
  - name: "crypto.createHash with MD5"
    vulnerable: true
    code: |
      const crypto = require('crypto');
      function hashPassword(password) {
          return crypto.createHash('md5').update(password).digest('hex');
      }
    expected_findings:
      - rule_id: "js-weak-crypto"

  - name: "crypto.createHash with SHA1"
    vulnerable: true
    code: |
      const crypto = require('crypto');
      function hash(data) {
          return crypto.createHash('sha1').update(data).digest('hex');
      }
    expected_findings:
      - rule_id: "js-weak-crypto"

  # TP: insecure random
  - name: "Math.random for token generation"
    vulnerable: true
    code: |
      function generateToken() {
          return Math.random().toString(36).substring(2);
      }
    expected_findings:
      - rule_id: "js-insecure-random"

  - name: "Math.random for ID generation"
    vulnerable: true
    code: |
      function generateId() {
          return 'id_' + Math.random().toString(36).slice(2, 11);
      }
    expected_findings:
      - rule_id: "js-insecure-random"

  # FP: safe patterns
  - name: "parameterized SQL query (safe)"
    vulnerable: false
    code: |
      function findUser(id) {
          return db.query('SELECT * FROM users WHERE id = $1', [id]);
      }

  - name: "crypto.createHash with SHA256 (safe)"
    vulnerable: false
    code: |
      const crypto = require('crypto');
      function hash(data) {
          return crypto.createHash('sha256').update(data).digest('hex');
      }

  - name: "crypto.randomBytes for token (safe)"
    vulnerable: false
    code: |
      const crypto = require('crypto');
      function generateToken() {
          return crypto.randomBytes(32).toString('hex');
      }

  - name: "prepared statement (safe)"
    vulnerable: false
    code: |
      const mysql = require('mysql2');
      async function findUser(conn, id) {
          const [rows] = await conn.execute('SELECT * FROM users WHERE id = ?', [id]);
          return rows[0];
      }

  - name: "uuid for ID generation (safe)"
    vulnerable: false
    code: |
      const { v4: uuidv4 } = require('uuid');
      function createUser(name) {
          return { id: uuidv4(), name: name };
      }
