# JavaScript XSS & DOM Manipulation
# Covers: innerHTML, document.write, outerHTML
# Rule IDs: js-xss, js-document-write, js-outerhtml-xss

id: "JS-XSS-DOM"
name: "JavaScript Cross-Site Scripting (DOM-based)"
language: "javascript"
vulnerability_type: "xss"
severity: "high"
cwe:
  - "CWE-79"
impact: "Cross-Site Scripting allowing execution of malicious scripts in user browsers"

test_cases:
  # TP: innerHTML
  - name: "innerHTML assignment"
    vulnerable: true
    code: |
      function render(content) {
          document.getElementById('output').innerHTML = content;
      }
    expected_findings:
      - rule_id: "js-xss"

  - name: "innerHTML in event handler"
    vulnerable: true
    code: |
      function onMessage(event) {
          const data = event.data;
          document.body.innerHTML = data;
      }
    expected_findings:
      - rule_id: "js-xss"

  # TP: document.write
  - name: "document.write call"
    vulnerable: true
    code: |
      function renderPage(html) {
          document.write(html);
      }
    expected_findings:
      - rule_id: "js-document-write"

  - name: "document.writeln call"
    vulnerable: true
    code: |
      function append(line) {
          document.writeln(line);
      }
    expected_findings:
      - rule_id: "js-document-write"

  # TP: outerHTML
  - name: "outerHTML assignment"
    vulnerable: true
    code: |
      function replaceElement(el, html) {
          el.outerHTML = html;
      }
    expected_findings:
      - rule_id: "js-outerhtml-xss"

  - name: "outerHTML on querySelector result"
    vulnerable: true
    code: |
      function update(selector, content) {
          document.querySelector(selector).outerHTML = content;
      }
    expected_findings:
      - rule_id: "js-outerhtml-xss"

  # FP: safe patterns
  - name: "textContent assignment (safe)"
    vulnerable: false
    code: |
      function display(text) {
          document.getElementById('output').textContent = text;
      }

  - name: "createElement with textContent (safe)"
    vulnerable: false
    code: |
      function addItem(text) {
          const li = document.createElement('li');
          li.textContent = text;
          document.getElementById('list').appendChild(li);
      }

  - name: "template literals without DOM insertion (safe)"
    vulnerable: false
    code: |
      function format(name, age) {
          return `Name: ${name}, Age: ${age}`;
      }

  - name: "DOM attribute setting (safe)"
    vulnerable: false
    code: |
      function setTitle(el, title) {
          el.setAttribute('title', title);
          el.dataset.value = title;
      }

  - name: "addEventListener only (safe)"
    vulnerable: false
    code: |
      function setup() {
          document.getElementById('btn').addEventListener('click', function() {
              alert('Clicked');
          });
      }
