# JavaScript Eval & Code Injection
# Covers: eval(), Function(), setTimeout/setInterval with strings
# Rule IDs: js-eval-direct, js-eval-indirect, js-new-function, js-child-process

id: "JS-CODE-INJECTION"
name: "JavaScript Code Injection"
language: "javascript"
vulnerability_type: "code_injection"
severity: "critical"
cwe:
  - "CWE-94"
  - "CWE-95"
impact: "Remote Code Execution via JavaScript code injection"

test_cases:
  # TP: direct eval
  - name: "eval with variable"
    vulnerable: true
    code: |
      function process(input) {
          eval(input);
      }
    expected_findings:
      - rule_id: "js-eval-direct"

  - name: "eval in arrow function"
    vulnerable: true
    code: |
      const handler = (code) => eval(code);
    expected_findings:
      - rule_id: "js-eval-direct"

  # TP: indirect eval via setTimeout/setInterval
  - name: "setTimeout with string argument"
    vulnerable: true
    code: |
      function delayed(code) {
          setTimeout("alert('xss')", 1000);
      }
    expected_findings:
      - rule_id: "js-eval-indirect"

  - name: "setInterval with string"
    vulnerable: true
    code: |
      function poll() {
          setInterval("checkStatus()", 5000);
      }
    expected_findings:
      - rule_id: "js-eval-indirect"

  # TP: new Function constructor
  - name: "new Function with user code"
    vulnerable: true
    code: |
      function createHandler(body) {
          return new Function('x', body);
      }
    expected_findings:
      - rule_id: "js-new-function"

  # TP: child_process
  - name: "child_process.exec call"
    vulnerable: true
    code: |
      const { exec } = require('child_process');
      function run(cmd) {
          exec(cmd, (err, stdout) => {
              console.log(stdout);
          });
      }
    expected_findings:
      - rule_id: "js-child-process"

  - name: "child_process.spawn"
    vulnerable: true
    code: |
      const child_process = require('child_process');
      function execute(command) {
          child_process.spawn(command);
      }
    expected_findings:
      - rule_id: "js-child-process"

  # FP: safe patterns
  - name: "JSON.parse (safe)"
    vulnerable: false
    code: |
      function parseData(input) {
          return JSON.parse(input);
      }

  - name: "setTimeout with function reference (safe)"
    vulnerable: false
    code: |
      function delayed() {
          setTimeout(function() {
              console.log('done');
          }, 1000);
      }

  - name: "console.log only (safe)"
    vulnerable: false
    code: |
      function greet(name) {
          console.log('Hello, ' + name);
          return name;
      }

  - name: "array operations (safe)"
    vulnerable: false
    code: |
      function transform(items) {
          return items.map(x => x * 2).filter(x => x > 10);
      }

  - name: "string method chaining (safe)"
    vulnerable: false
    code: |
      function normalize(input) {
          return input.trim().toLowerCase().replace(/\s+/g, '-');
      }
