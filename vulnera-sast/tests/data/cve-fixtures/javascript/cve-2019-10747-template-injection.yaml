# CVE-2019-10747: Pug/Jade Server-Side Template Injection
# Also covers EJS, Handlebars, and other Node.js template engines
# Impact: Remote Code Execution through template compilation

id: "CVE-2019-10747"
name: "Node.js Server-Side Template Injection (SSTI)"
language: "javascript"
vulnerability_type: "ssti"
severity: "critical"
cwe:
  - "CWE-94"
  - "CWE-1336"
impact: "Remote Code Execution; attackers can execute arbitrary JavaScript/Node.js code, access file system, environment variables, and potentially pivot to other systems"
description: |
  Server-Side Template Injection occurs when user input is directly passed to
  template engines for compilation. Unlike XSS (client-side), SSTI allows attackers
  to execute code on the server. In Node.js, popular template engines like Pug,
  EJS, Handlebars, and Nunjucks are vulnerable if user input is compiled as template.
  
  CVE-2019-10747 specifically affected Pug, but the pattern applies broadly.
  Real-world impact: Full server compromise, data exfiltration, lateral movement.

test_cases:
  # Vulnerable patterns - Pug/Jade
  - name: "pug.compile with user input"
    vulnerable: true
    code: |
      const pug = require('pug');
      const express = require('express');
      const app = express();

      app.get('/render', (req, res) => {
          const userTemplate = req.query.template;
          const compiled = pug.compile(userTemplate);
          res.send(compiled({ message: 'hello' }));
      });
    expected_findings:
      - rule_id: "ssti"
        line: 7
        severity: "critical"
        message_contains: "template"
    taint_path: "req.query.template → pug.compile()"

  - name: "pug.render with user template string"
    vulnerable: true
    code: |
      const pug = require('pug');
      const express = require('express');
      const app = express();

      app.post('/preview', (req, res) => {
          const template = req.body.template;
          const html = pug.render(template, { user: req.user });
          res.send(html);
      });
    expected_findings:
      - rule_id: "ssti"
        line: 7
        severity: "critical"
    taint_path: "req.body.template → pug.render()"

  # Vulnerable patterns - EJS
  - name: "ejs.render with user input"
    vulnerable: true
    code: |
      const ejs = require('ejs');
      const express = require('express');
      const app = express();

      app.get('/profile', (req, res) => {
          const name = req.query.name;
          const html = ejs.render(`<h1>Welcome <%= ${name} %></h1>`);
          res.send(html);
      });
    expected_findings:
      - rule_id: "ssti"
        line: 7
        severity: "critical"
    taint_path: "req.query.name → template string → ejs.render()"

  - name: "ejs.compile with user template"
    vulnerable: true
    code: |
      const ejs = require('ejs');

      function renderUserTemplate(req, res) {
          const templateStr = req.body.customTemplate;
          const compiledFn = ejs.compile(templateStr);
          res.send(compiledFn({ data: req.body.data }));
      }
    expected_findings:
      - rule_id: "ssti"
        line: 5
        severity: "critical"
    taint_path: "req.body.customTemplate → ejs.compile()"

  # Vulnerable patterns - Nunjucks
  - name: "nunjucks.renderString with user input"
    vulnerable: true
    code: |
      const nunjucks = require('nunjucks');
      const express = require('express');
      const app = express();

      app.post('/email-preview', (req, res) => {
          const emailTemplate = req.body.template;
          const rendered = nunjucks.renderString(emailTemplate, {
              user: req.user,
              company: 'ACME'
          });
          res.send(rendered);
      });
    expected_findings:
      - rule_id: "ssti"
        line: 7
        severity: "critical"
    taint_path: "req.body.template → nunjucks.renderString()"

  # Vulnerable patterns - Handlebars
  - name: "handlebars.compile with user input"
    vulnerable: true
    code: |
      const Handlebars = require('handlebars');

      async function generateReport(req, res) {
          const reportTemplate = req.body.template;
          const template = Handlebars.compile(reportTemplate);
          const html = template({ data: req.body.reportData });
          res.send(html);
      }
    expected_findings:
      - rule_id: "ssti"
        line: 5
        severity: "critical"
    taint_path: "req.body.template → Handlebars.compile()"

  # Safe patterns
  - name: "pug.renderFile with static template (safe)"
    vulnerable: false
    code: |
      const pug = require('pug');
      const path = require('path');
      const express = require('express');
      const app = express();

      app.get('/profile', (req, res) => {
          const templatePath = path.join(__dirname, 'views', 'profile.pug');
          const html = pug.renderFile(templatePath, {
              name: req.query.name  // User data as context, not template
          });
          res.send(html);
      });
    expected_findings: []

  - name: "ejs with static template file (safe)"
    vulnerable: false
    code: |
      const express = require('express');
      const app = express();

      app.set('view engine', 'ejs');
      app.set('views', './views');

      app.get('/user', (req, res) => {
          // Safe: using res.render with file path, user data only in context
          res.render('user', { username: req.query.username });
      });
    expected_findings: []

  - name: "nunjucks with precompiled templates (safe)"
    vulnerable: false
    code: |
      const nunjucks = require('nunjucks');
      const express = require('express');
      const app = express();

      // Configure nunjucks with static templates directory
      nunjucks.configure('templates', { autoescape: true });

      app.get('/page', (req, res) => {
          // Safe: rendering a static template file with user data as context
          res.send(nunjucks.render('page.html', { title: req.query.title }));
      });
    expected_findings: []

  - name: "handlebars with registered template (safe)"
    vulnerable: false
    code: |
      const Handlebars = require('handlebars');
      const fs = require('fs');

      // Precompile static template at startup
      const templateSource = fs.readFileSync('./templates/email.hbs', 'utf8');
      const emailTemplate = Handlebars.compile(templateSource);

      function sendEmail(req, res) {
          // Safe: using precompiled template with user data as context
          const html = emailTemplate({
              recipientName: req.body.name,
              message: req.body.message
          });
          sendMail(html);
      }
    expected_findings: []
