# Rust Command Injection & SQL Injection
# Covers: Command::new, format!() SQL, static mut, forget
# Rule IDs: rust-command, rust-format-sql, rust-static-mut, rust-forget

id: "RUST-INJECTION"
name: "Rust Command & SQL Injection"
language: "rust"
vulnerability_type: "injection"
severity: "high"
cwe:
  - "CWE-78"
  - "CWE-89"
impact: "Command injection and SQL injection through unsafe patterns"

test_cases:
  # TP: Command::new
  - name: "Command::new with user input"
    vulnerable: true
    code: |
      use std::process::Command;
      fn run(cmd: &str) {
          Command::new(cmd).output().ok();
      }
    expected_findings:
      - rule_id: "rust-command"

  - name: "Command::new with arg"
    vulnerable: true
    code: |
      use std::process::Command;
      fn execute(program: &str, arg: &str) {
          Command::new(program).arg(arg).spawn().ok();
      }
    expected_findings:
      - rule_id: "rust-command"

  # TP: format! SQL
  - name: "format! with SQL query"
    vulnerable: true
    code: |
      fn query_user(id: &str) -> String {
          format!("SELECT * FROM users WHERE id = '{}'", id)
      }
    expected_findings:
      - rule_id: "rust-format-sql"

  - name: "format! with INSERT"
    vulnerable: true
    code: |
      fn insert_record(name: &str, email: &str) -> String {
          format!("INSERT INTO users (name, email) VALUES ('{}', '{}')", name, email)
      }
    expected_findings:
      - rule_id: "rust-format-sql"

  # TP: static mut
  - name: "static mut variable"
    vulnerable: true
    code: |
      static mut COUNTER: u64 = 0;
      fn increment() {
          unsafe { COUNTER += 1; }
      }
    expected_findings:
      - rule_id: "rust-static-mut"

  # TP: mem::forget
  - name: "mem::forget usage"
    vulnerable: true
    code: |
      fn leak_resource(data: Vec<u8>) {
          std::mem::forget(data);
      }
    expected_findings:
      - rule_id: "rust-forget"

  # FP: safe patterns
  - name: "Command with hardcoded args (safe)"
    vulnerable: false
    code: |
      use std::process::Command;
      fn list_files() -> std::io::Result<std::process::Output> {
          Command::new("ls").arg("-la").output()
      }

  - name: "parameterized query (safe)"
    vulnerable: false
    code: |
      async fn find_user(pool: &Pool, id: i64) -> Result<User, Error> {
          sqlx::query_as("SELECT * FROM users WHERE id = $1")
              .bind(id)
              .fetch_one(pool)
              .await
      }

  - name: "atomic instead of static mut (safe)"
    vulnerable: false
    code: |
      use std::sync::atomic::{AtomicU64, Ordering};
      static COUNTER: AtomicU64 = AtomicU64::new(0);
      fn increment() -> u64 {
          COUNTER.fetch_add(1, Ordering::SeqCst)
      }

  - name: "drop instead of forget (safe)"
    vulnerable: false
    code: |
      fn cleanup(data: Vec<u8>) {
          drop(data);
      }

  - name: "safe string formatting (safe)"
    vulnerable: false
    code: |
      fn greet(name: &str) -> String {
          format!("Hello, {}!", name)
      }
