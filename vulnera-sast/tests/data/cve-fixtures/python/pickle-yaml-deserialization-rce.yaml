# Python Pickle/YAML Deserialization RCE
# This vulnerability pattern has been responsible for numerous CVEs including:
# - CVE-2017-6950 (Django Pickle Session), CVE-2022-21699 (Jupyter), many others
# Impact: Remote Code Execution through object instantiation

id: "PICKLE-YAML-RCE"
name: "Python Unsafe Deserialization (Pickle/YAML)"
language: "python"
vulnerability_type: "deserialization_rce"
severity: "critical"
cwe:
  - "CWE-502"
  - "CWE-94"
impact: "Remote Code Execution; attackers can execute arbitrary Python code on the server, leading to complete system compromise"
description: |
  Python's pickle module is inherently unsafe when used with untrusted data.
  The pickle protocol allows arbitrary code execution during deserialization.
  Similarly, PyYAML's yaml.load() (without SafeLoader) allows arbitrary Python
  object instantiation, which can be exploited for RCE.
  
  Real-world impact: This vulnerability class has affected major projects like
  Django (session serialization), Jupyter notebooks, and numerous ML/AI pipelines
  that serialize model data with pickle.

test_cases:
  # Vulnerable patterns - Pickle
  - name: "pickle.loads with user data"
    vulnerable: true
    code: |
      import pickle
      from flask import request

      @app.route('/load', methods=['POST'])
      def load_data():
          serialized = request.files['data'].read()
          user_obj = pickle.loads(serialized)
          return str(user_obj)
    expected_findings:
      - rule_id: "deserialization"
        line: 7
        severity: "critical"
        message_contains: "pickle"
    taint_path: "request.files['data'].read() → pickle.loads()"

  - name: "pickle.load from uploaded file"
    vulnerable: true
    code: |
      import pickle
      from flask import request
      import tempfile

      @app.route('/upload', methods=['POST'])
      def upload_model():
          f = request.files['model']
          with tempfile.NamedTemporaryFile() as tmp:
              f.save(tmp.name)
              tmp.seek(0)
              model = pickle.load(tmp)
          return model.predict([1, 2, 3])
    expected_findings:
      - rule_id: "deserialization"
        line: 11
        severity: "critical"
    taint_path: "request.files['model'] → file.save() → pickle.load()"

  # Vulnerable patterns - YAML
  - name: "yaml.load without SafeLoader"
    vulnerable: true
    code: |
      import yaml
      from flask import request

      @app.route('/config', methods=['POST'])
      def update_config():
          yaml_data = request.form['config']
          config = yaml.load(yaml_data)  # Unsafe! No Loader specified
          return apply_config(config)
    expected_findings:
      - rule_id: "python-yaml-load"
        line: 7
        severity: "critical"
        message_contains: "yaml"
    taint_path: "request.form['config'] → yaml.load()"

  - name: "yaml.load with Loader=yaml.Loader (unsafe)"
    vulnerable: true
    code: |
      import yaml
      from flask import request

      @app.route('/settings', methods=['POST'])
      def load_settings():
          data = request.get_json()['yaml_content']
          settings = yaml.load(data, Loader=yaml.Loader)
          return settings
    expected_findings:
      - rule_id: "python-yaml-load"
        line: 7
        severity: "critical"
    taint_path: "request.get_json() → yaml.load(Loader=yaml.Loader)"

  - name: "yaml.unsafe_load explicit"
    vulnerable: true
    code: |
      import yaml
      from django.http import HttpRequest

      def parse_yaml(request: HttpRequest):
          content = request.body.decode('utf-8')
          data = yaml.unsafe_load(content)
          return data
    expected_findings:
      - rule_id: "python-yaml-load"
        line: 6
        severity: "critical"
    taint_path: "request.body → yaml.unsafe_load()"

  # Safe patterns
  - name: "yaml.safe_load (safe)"
    vulnerable: false
    code: |
      import yaml
      from flask import request

      @app.route('/config', methods=['POST'])
      def update_config_safe():
          yaml_data = request.form['config']
          config = yaml.safe_load(yaml_data)
          return apply_config(config)
    expected_findings: []

  - name: "yaml.load with SafeLoader (safe)"
    vulnerable: false
    code: |
      import yaml
      from flask import request

      @app.route('/settings', methods=['POST'])
      def load_settings_safe():
          data = request.get_json()['yaml_content']
          settings = yaml.load(data, Loader=yaml.SafeLoader)
          return settings
    expected_findings: []

  - name: "json.loads instead of pickle (safe)"
    vulnerable: false
    code: |
      import json
      from flask import request

      @app.route('/data', methods=['POST'])
      def load_json_data():
          data = request.get_data(as_text=True)
          obj = json.loads(data)
          return obj
    expected_findings: []

  - name: "pickle with trusted internal data (context: not from user)"
    vulnerable: true
    code: |
      import pickle
      from pathlib import Path

      CACHE_DIR = Path('/var/cache/app')

      def load_cached_model(model_name: str):
          # Only loading from trusted cache directory, not user input
          cache_file = CACHE_DIR / f"{model_name}.pkl"
          if not cache_file.exists():
              return None
          with open(cache_file, 'rb') as f:
              return pickle.load(f)
    expected_findings:
      - rule_id: "unsafe-deserialization"
