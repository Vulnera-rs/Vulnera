# Python Command Injection & Code Execution
# Covers: subprocess, os.system, eval, exec injection patterns
# Rule IDs: unsafe-function-call, python-exec, python-subprocess, python-os-system

id: "PY-CMD-INJECTION"
name: "Python Command Injection & Code Execution"
language: "python"
vulnerability_type: "command_injection"
severity: "critical"
cwe:
  - "CWE-78"
  - "CWE-94"
impact: "Remote Code Execution via command injection or dynamic code evaluation"

test_cases:
  # TP: eval() usage
  - name: "eval with user input"
    vulnerable: true
    code: |
      def calculate(expr):
          result = eval(expr)
          return result
    expected_findings:
      - rule_id: "unsafe-function-call"
        severity: "medium"

  - name: "eval in lambda"
    vulnerable: true
    code: |
      handler = lambda x: eval(x)
    expected_findings:
      - rule_id: "unsafe-function-call"

  # TP: exec() usage
  - name: "exec with dynamic code"
    vulnerable: true
    code: |
      def run_code(code_str):
          exec(code_str)
    expected_findings:
      - rule_id: "python-exec"
        severity: "high"

  - name: "exec in class method"
    vulnerable: true
    code: |
      class Runner:
          def execute(self, script):
              exec(script)
    expected_findings:
      - rule_id: "python-exec"

  # TP: subprocess with shell=True
  - name: "subprocess.call with shell=True"
    vulnerable: true
    code: |
      import subprocess
      def run_command(cmd):
          subprocess.call(cmd, shell=True)
    expected_findings:
      - rule_id: "python-subprocess"

  - name: "subprocess.Popen with shell=True"
    vulnerable: true
    code: |
      import subprocess
      def spawn(command):
          p = subprocess.Popen(command, shell=True, stdout=subprocess.PIPE)
          return p.communicate()
    expected_findings:
      - rule_id: "python-subprocess"

  # TP: os.system
  - name: "os.system call"
    vulnerable: true
    code: |
      import os
      def execute(cmd):
          os.system(cmd)
    expected_findings:
      - rule_id: "python-os-system"

  # FP: safe alternatives
  - name: "ast.literal_eval instead of eval (safe)"
    vulnerable: false
    code: |
      import ast
      def parse_value(text):
          return ast.literal_eval(text)

  - name: "shlex.split for command building (safe)"
    vulnerable: false
    code: |
      import shlex
      import subprocess
      def run(command_str):
          args = shlex.split(command_str)
          return subprocess.run(args, capture_output=True)

  - name: "print function not flagged (safe)"
    vulnerable: false
    code: |
      def greet(name):
          message = f"Hello, {name}"
          print(message)
          return message

  - name: "math operations only (safe)"
    vulnerable: false
    code: |
      def compute(a, b):
          total = a + b
          average = total / 2
          return average
