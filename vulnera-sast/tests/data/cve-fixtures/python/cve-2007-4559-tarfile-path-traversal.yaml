# CVE-2007-4559: Python tarfile path traversal during extraction
# Impact: Arbitrary file overwrite via crafted archive member names

id: "CVE-2007-4559"
name: "Python Tarfile Extraction Path Traversal"
language: "python"
vulnerability_type: "path_traversal"
severity: "critical"
cwe:
  - "CWE-22"
  - "CWE-73"
impact: "Attackers can overwrite files outside extraction directory by using ../ paths in tar headers"
description: |
  Extracting attacker-controlled tar archives with extractall() can write files
  outside the target directory unless member paths are validated.

test_cases:
  - name: "unsafe tar.extractall on untrusted upload"
    vulnerable: true
    code: |
      import tarfile

      def restore_backup(archive_path, output_dir):
          with tarfile.open(archive_path, 'r:gz') as tar:
              tar.extractall(output_dir)
    expected_findings:
      - rule_id: "tarfile-path-traversal"
        line: 5
        severity: "critical"
        message_contains: "extract"

  - name: "unsafe tar.extractall with user-controlled destination"
    vulnerable: true
    code: |
      import tarfile

      def unpack(archive, req):
          with tarfile.open(archive, 'r') as tf:
              tf.extractall(req.args.get('dest', '/tmp/out'))
    expected_findings:
      - rule_id: "path_traversal"
        line: 5
        severity: "high"

  - name: "safe inspection only without extraction"
    vulnerable: false
    code: |
      import tarfile

      def list_members(archive_path):
          with tarfile.open(archive_path, 'r:*') as tf:
              return [m.name for m in tf.getmembers()]
    expected_findings: []
