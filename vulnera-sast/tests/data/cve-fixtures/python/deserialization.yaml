# Python Unsafe Deserialization
# Covers: pickle.loads/load, yaml.load without SafeLoader
# Rule IDs: unsafe-deserialization, python-yaml-load

id: "PY-DESERIALIZATION"
name: "Python Unsafe Deserialization"
language: "python"
vulnerability_type: "deserialization"
severity: "critical"
cwe:
  - "CWE-502"
impact: "Remote Code Execution through unsafe deserialization of untrusted data"

test_cases:
  # TP: pickle
  - name: "pickle.loads direct call"
    vulnerable: true
    code: |
      import pickle
      def deserialize(data):
          obj = pickle.loads(data)
          return obj
    expected_findings:
      - rule_id: "unsafe-deserialization"

  - name: "pickle.load from file"
    vulnerable: true
    code: |
      import pickle
      def load_model(path):
          with open(path, 'rb') as f:
              model = pickle.load(f)
          return model
    expected_findings:
      - rule_id: "unsafe-deserialization"

  # TP: yaml.load
  - name: "yaml.load without SafeLoader"
    vulnerable: true
    code: |
      import yaml
      def parse_config(text):
          data = yaml.load(text)
          return data
    expected_findings:
      - rule_id: "python-yaml-load"

  - name: "yaml.unsafe_load explicit"
    vulnerable: true
    code: |
      import yaml
      def parse(raw):
          return yaml.unsafe_load(raw)
    expected_findings:
      - rule_id: "python-yaml-load"

  - name: "shelve.open (uses pickle internally)"
    vulnerable: true
    code: |
      import shelve
      def read_data(path):
          db = shelve.open(path)
          data = db['key']
          db.close()
          return data
    expected_findings:
      - rule_id: "unsafe-deserialization"

  # FP: safe alternatives
  - name: "json.loads (safe)"
    vulnerable: false
    code: |
      import json
      def parse_json(text):
          return json.loads(text)

  - name: "yaml.safe_load (safe)"
    vulnerable: false
    code: |
      import yaml
      def parse_config(text):
          return yaml.safe_load(text)

  - name: "yaml.load with SafeLoader (safe)"
    vulnerable: false
    code: |
      import yaml
      def parse(raw):
          return yaml.load(raw, Loader=yaml.SafeLoader)

  - name: "struct.unpack (safe)"
    vulnerable: false
    code: |
      import struct
      def read_header(data):
          magic, version = struct.unpack('4sI', data[:8])
          return magic, version

  - name: "csv reader (safe)"
    vulnerable: false
    code: |
      import csv
      import io
      def parse_csv(text):
          reader = csv.DictReader(io.StringIO(text))
          return list(reader)
