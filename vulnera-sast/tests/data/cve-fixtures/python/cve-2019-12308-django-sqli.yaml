# CVE-2019-12308: Django SQL Injection
# Affected: Django 1.11 before 1.11.21, 2.1 before 2.1.9, 2.2 before 2.2.2
# Impact: Complete database compromise via clickjacking through admin changelist URLs
# Real-world damage: Millions of Django deployments potentially vulnerable

id: "CVE-2019-12308"
name: "Django SQL Injection via Raw Query"
language: "python"
vulnerability_type: "sql_injection"
severity: "critical"
cwe:
  - "CWE-89"
impact: "Complete database compromise; attackers can read, modify, or delete any data; potential for privilege escalation and lateral movement"
description: |
  Django applications using raw SQL queries with string interpolation are vulnerable to SQL injection.
  This pattern was commonly seen in Django 1.x and 2.x applications before the community
  emphasized using parameterized queries. The vulnerability allows attackers to inject
  arbitrary SQL commands through user input.

test_cases:
  # Vulnerable patterns
  - name: "f-string SQL injection in cursor.execute"
    vulnerable: true
    code: |
      from django.db import connection
      from django.http import HttpRequest

      def get_user(request: HttpRequest):
          user_id = request.GET.get('id')
          query = f"SELECT * FROM users WHERE id = {user_id}"
          cursor = connection.cursor()
          cursor.execute(query)
          return cursor.fetchone()
    expected_findings:
      - rule_id: "sql_injection"
        line: 7
        severity: "high"
        message_contains: "SQL injection"
    taint_path: "request.GET.get() → f-string interpolation → cursor.execute()"

  - name: "string concatenation SQL injection"
    vulnerable: true
    code: |
      from django.db import connection

      def search_users(request):
          name = request.POST.get('name')
          query = "SELECT * FROM users WHERE name = '" + name + "'"
          cursor = connection.cursor()
          cursor.execute(query)
          return cursor.fetchall()
    expected_findings:
      - rule_id: "sql_injection"
        line: 6
        severity: "high"
    taint_path: "request.POST.get() → string concatenation → cursor.execute()"

  - name: "format string SQL injection"
    vulnerable: true
    code: |
      from django.db import connection

      def get_orders(request):
          status = request.GET.get('status')
          query = "SELECT * FROM orders WHERE status = '%s'" % status
          cursor = connection.cursor()
          cursor.execute(query)
          return cursor.fetchall()
    expected_findings:
      - rule_id: "sql_injection"
        line: 6
        severity: "high"
    taint_path: "request.GET.get() → % format → cursor.execute()"

  - name: "multi-hop taint propagation"
    vulnerable: true
    code: |
      from django.db import connection

      def process_input(user_input):
          return user_input.strip()

      def get_data(request):
          raw_id = request.GET.get('id')
          clean_id = process_input(raw_id)
          query = f"SELECT * FROM data WHERE id = {clean_id}"
          cursor = connection.cursor()
          cursor.execute(query)
          return cursor.fetchone()
    expected_findings:
      - rule_id: "sql_injection"
        line: 10
        severity: "high"
    taint_path: "request.GET.get() → process_input() → f-string → cursor.execute()"

  # Safe patterns (should NOT trigger findings)
  - name: "parameterized query with list"
    vulnerable: false
    code: |
      from django.db import connection

      def get_user_safe(request):
          user_id = request.GET.get('id')
          cursor = connection.cursor()
          cursor.execute("SELECT * FROM users WHERE id = %s", [user_id])
          return cursor.fetchone()
    expected_findings: []

  - name: "parameterized query with tuple"
    vulnerable: false
    code: |
      from django.db import connection

      def search_users_safe(request):
          name = request.POST.get('name')
          cursor = connection.cursor()
          cursor.execute("SELECT * FROM users WHERE name = %s", (name,))
          return cursor.fetchall()
    expected_findings: []

  - name: "Django ORM query (safe)"
    vulnerable: false
    code: |
      from django.contrib.auth.models import User

      def get_user_orm(request):
          user_id = request.GET.get('id')
          return User.objects.filter(id=user_id).first()
    expected_findings: []

  - name: "integer conversion sanitization"
    vulnerable: false
    code: |
      from django.db import connection

      def get_user_int(request):
          user_id = int(request.GET.get('id', 0))
          query = f"SELECT * FROM users WHERE id = {user_id}"
          cursor = connection.cursor()
          cursor.execute(query)
          return cursor.fetchone()
    expected_findings: []
