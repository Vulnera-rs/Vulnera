# TypeScript Code Injection & XSS
# Covers: ts-eval, ts-innerhtml, ts-child-process, ts-non-null-assertion
# Rule IDs: ts-eval, ts-innerhtml, ts-child-process, ts-non-null-assertion, ts-any-type

id: "TS-INJECTION-XSS"
name: "TypeScript Code Injection & XSS"
language: "typescript"
vulnerability_type: "injection"
severity: "high"
cwe:
  - "CWE-94"
  - "CWE-79"
impact: "Code injection and XSS through TypeScript-specific patterns"

test_cases:
  # TP: eval
  - name: "eval in TypeScript function"
    vulnerable: true
    code: |
      function execute(code: string): unknown {
          return eval(code);
      }
    expected_findings:
      - rule_id: "ts-eval"

  - name: "eval in async handler"
    vulnerable: true
    code: |
      async function handle(input: string): Promise<void> {
          eval(input);
      }
    expected_findings:
      - rule_id: "ts-eval"

  # TP: innerHTML
  - name: "innerHTML assignment in TS"
    vulnerable: true
    code: |
      function render(el: HTMLElement, content: string): void {
          el.innerHTML = content;
      }
    expected_findings:
      - rule_id: "ts-innerhtml"

  - name: "innerHTML via getElementById"
    vulnerable: true
    code: |
      function display(html: string): void {
          const el = document.getElementById('container');
          if (el) {
              el.innerHTML = html;
          }
      }
    expected_findings:
      - rule_id: "ts-innerhtml"

  # TP: child-process
  - name: "execSync call"
    vulnerable: true
    code: |
      import { execSync } from 'child_process';
      function runCommand(cmd: string): string {
          return execSync(cmd).toString();
      }
    expected_findings:
      - rule_id: "ts-child-process"

  - name: "spawn call"
    vulnerable: true
    code: |
      import { spawn } from 'child_process';
      function execute(command: string): void {
          spawn(command);
      }
    expected_findings:
      - rule_id: "ts-child-process"

  # TP: non-null assertion
  - name: "non-null assertion operator"
    vulnerable: true
    code: |
      function process(value: string | null): number {
          return value!.length;
      }
    expected_findings:
      - rule_id: "ts-non-null-assertion"

  # FP: safe patterns
  - name: "typed function with validation (safe)"
    vulnerable: false
    code: |
      function safeParse(input: string): number {
          const parsed = parseInt(input, 10);
          if (isNaN(parsed)) {
              throw new Error('Invalid number');
          }
          return parsed;
      }

  - name: "textContent in TypeScript (safe)"
    vulnerable: false
    code: |
      function display(el: HTMLElement, text: string): void {
          el.textContent = text;
      }

  - name: "optional chaining instead of non-null (safe)"
    vulnerable: false
    code: |
      function getLength(value: string | null): number {
          return value?.length ?? 0;
      }

  - name: "type guard (safe)"
    vulnerable: false
    code: |
      function isString(value: unknown): value is string {
          return typeof value === 'string';
      }

  - name: "pure computation (safe)"
    vulnerable: false
    code: |
      function add(a: number, b: number): number {
          return a + b;
      }
