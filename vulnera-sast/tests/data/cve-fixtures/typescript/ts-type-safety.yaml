# TypeScript Type Safety & SQL Injection
# Covers: ts-any-type, ts-sql-injection, ts-type-assertion, ts-ignore
# Rule IDs: ts-any-type, ts-sql-injection, ts-type-assertion, ts-ignore

id: "TS-TYPE-SAFETY"
name: "TypeScript Type Safety & SQL Injection"
language: "typescript"
vulnerability_type: "type_safety"
severity: "medium"
cwe:
  - "CWE-89"
  - "CWE-704"
impact: "Weakened type safety and SQL injection vulnerabilities"

test_cases:
  # TP: any type
  - name: "explicit any type annotation"
    vulnerable: true
    code: |
      function process(data: any): string {
          return data.toString();
      }
    expected_findings:
      - rule_id: "ts-any-type"

  - name: "any in function parameter"
    vulnerable: true
    code: |
      const handler = (event: any) => {
          console.log(event.target.value);
      };
    expected_findings:
      - rule_id: "ts-any-type"

  # TP: type assertion
  - name: "type assertion with as"
    vulnerable: true
    code: |
      function unsafeCast(value: unknown): string {
          return value as string;
      }
    expected_findings:
      - rule_id: "ts-type-assertion"

  # TP: ts-ignore
  - name: "ts-ignore comment"
    vulnerable: true
    code: |
      function risky(): void {
          // @ts-ignore
          undeclaredFunction();
      }
    expected_findings:
      - rule_id: "ts-ignore"

  # TP: SQL injection
  - name: "SQL template literal"
    vulnerable: true
    code: |
      async function findUser(id: string): Promise<any> {
          const query = `SELECT * FROM users WHERE id = '${id}'`;
          return db.query(query);
      }
    expected_findings:
      - rule_id: "ts-sql-injection"

  - name: "SQL string concatenation"
    vulnerable: true
    code: |
      function buildQuery(name: string): string {
          return "SELECT * FROM users WHERE name = '" + name + "'";
      }
    expected_findings:
      - rule_id: "ts-sql-injection"

  # FP: safe patterns
  - name: "unknown type with type guard (safe)"
    vulnerable: false
    code: |
      function safeProcess(data: unknown): string {
          if (typeof data === 'string') {
              return data;
          }
          return String(data);
      }

  - name: "generic function (safe)"
    vulnerable: false
    code: |
      function identity<T>(value: T): T {
          return value;
      }

  - name: "parameterized query (safe)"
    vulnerable: false
    code: |
      async function findUser(id: string): Promise<unknown> {
          return db.query('SELECT * FROM users WHERE id = $1', [id]);
      }

  - name: "proper null handling (safe)"
    vulnerable: false
    code: |
      function getLength(value: string | null): number {
          if (value === null) {
              return 0;
          }
          return value.length;
      }

  - name: "interface with strict types (safe)"
    vulnerable: false
    code: |
      interface User {
          id: number;
          name: string;
          email: string;
      }
      function createUser(name: string, email: string): User {
          return { id: Date.now(), name, email };
      }
