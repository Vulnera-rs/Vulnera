# Rust security rules â€” 18 rules

[[rules]]
id = "null-pointer"
name = "Unwrap Without Check"
description = "unwrap() can panic if the value is None or Err"
severity = "Medium"
languages = ["Rust"]
cwe_ids = ["CWE-476"]
owasp_categories = []
tags = ["panic", "error-handling", "rust"]
message = "Use match, if let, or ? operator instead of unwrap()."

[rules.options]
suppress_in_tests = true

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(call_expression
  function: (field_expression
    field: (field_identifier) @fn
  )
  (#eq? @fn "unwrap")
) @call
'''

[[rules]]
id = "expect-panic"
name = "Expect Panic"
description = "expect() can panic with a custom message"
severity = "Medium"
languages = ["Rust"]
cwe_ids = ["CWE-476"]
owasp_categories = []
tags = ["panic", "error-handling", "rust"]
message = "Consider using match or ? operator for recoverable errors."

[rules.options]
suppress_in_tests = true

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(call_expression
  function: (field_expression
    field: (field_identifier) @fn
  )
  (#eq? @fn "expect")
) @call
'''

[[rules]]
id = "rust-panic"
name = "Explicit Panic"
description = "panic!() will abort the program"
severity = "Low"
languages = ["Rust"]
cwe_ids = ["CWE-754"]
owasp_categories = []
tags = ["panic", "rust"]
message = "Return Result/Option instead of panicking where appropriate."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(macro_invocation
  macro: (identifier) @macro
  (#eq? @macro "panic")
) @call
'''

[[rules]]
id = "rust-todo"
name = "Unimplemented Code"
description = "todo!() / unimplemented!() will panic at runtime"
severity = "Low"
languages = ["Rust"]
cwe_ids = ["CWE-754"]
owasp_categories = []
tags = ["incomplete", "panic", "rust"]
message = "Ensure todo!() and unimplemented!() are not in production code."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(macro_invocation
  macro: (identifier) @macro
  (#match? @macro "^(todo|unimplemented)$")
) @call
'''

[[rules]]
id = "rust-unreachable"
name = "Unreachable Code"
description = "unreachable!() will panic if reached"
severity = "Low"
languages = ["Rust"]
cwe_ids = ["CWE-754"]
owasp_categories = []
tags = ["panic", "rust"]
message = "Verify that unreachable!() is truly unreachable."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(macro_invocation
  macro: (identifier) @macro
  (#eq? @macro "unreachable")
) @call
'''

[[rules]]
id = "rust-unsafe"
name = "Unsafe Block"
description = "unsafe block bypasses Rust's safety guarantees"
severity = "Medium"
languages = ["Rust"]
cwe_ids = ["CWE-119"]
owasp_categories = []
tags = ["unsafe", "rust"]
message = "Review unsafe code carefully. Document safety invariants."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(unsafe_block) @unsafe
'''

[[rules]]
id = "rust-unsafe-fn"
name = "Unsafe Function"
description = "unsafe function declaration bypasses Rust's safety guarantees"
severity = "Medium"
languages = ["Rust"]
cwe_ids = ["CWE-119"]
owasp_categories = []
tags = ["unsafe", "rust"]
message = "Review unsafe code carefully. Document safety invariants."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(function_item
  (visibility_modifier)?
  "unsafe"
  "fn"
) @unsafe_fn
'''

[[rules]]
id = "rust-unsafe-impl"
name = "Unsafe Implementation"
description = "unsafe trait implementation bypasses Rust's safety guarantees"
severity = "Medium"
languages = ["Rust"]
cwe_ids = ["CWE-119"]
owasp_categories = []
tags = ["unsafe", "rust"]
message = "Review unsafe code carefully. Document safety invariants."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(unsafe_impl) @unsafe_impl
'''

[[rules]]
id = "rust-transmute"
name = "Transmute"
description = "std::mem::transmute can cause undefined behavior"
severity = "High"
languages = ["Rust"]
cwe_ids = ["CWE-843"]
owasp_categories = []
tags = ["unsafe", "transmute", "rust"]
message = "Avoid transmute. Use safe alternatives like TryFrom/TryInto."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(call_expression
  function: (scoped_identifier
    name: (identifier) @fn
  )
  (#eq? @fn "transmute")
) @call
'''

[[rules]]
id = "rust-raw-pointer"
name = "Raw Pointer Dereference"
description = "Dereferencing raw pointers is unsafe"
severity = "Medium"
languages = ["Rust"]
cwe_ids = ["CWE-119", "CWE-476"]
owasp_categories = []
tags = ["unsafe", "pointer", "rust"]
message = "Ensure pointer validity before dereferencing."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(unary_expression
  operator: "*"
  argument: (identifier) @ptr
) @deref
'''

[[rules]]
id = "rust-command"
name = "Command Execution"
description = "Command::new may be vulnerable to command injection"
severity = "High"
languages = ["Rust"]
cwe_ids = ["CWE-78"]
owasp_categories = ["A03:2021 - Injection"]
tags = ["injection", "command", "rust"]
message = "Validate and sanitize command arguments."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
; Match Command::new() with any argument (identifier, string, expression)
(call_expression
  function: (scoped_identifier
    path: (identifier) @mod
    name: (identifier) @fn
  )
  arguments: (arguments
    [
      (identifier)
      (field_expression)
      (call_expression)
      (macro_invocation)
      (index_expression)
    ] @arg
  )
  (#eq? @mod "Command")
  (#eq? @fn "new")
) @call
'''

[[rules]]
id = "rust-sql-injection"
name = "SQL Injection"
description = "Raw SQL query may be vulnerable to injection"
severity = "High"
languages = ["Rust"]
cwe_ids = ["CWE-89"]
owasp_categories = ["A03:2021 - Injection"]
tags = ["injection", "sql", "rust"]
message = "Use parameterized queries instead of string concatenation."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(call_expression
  function: (field_expression
    field: (field_identifier) @fn
  )
  (#match? @fn "^(query|execute)$")
) @call
'''

[[rules]]
id = "rust-file-permission"
name = "Overly Permissive File"
description = "File created with overly permissive permissions"
severity = "Medium"
languages = ["Rust"]
cwe_ids = ["CWE-732"]
owasp_categories = ["A01:2021 - Broken Access Control"]
tags = ["file", "permissions", "rust"]
message = "Avoid overly permissive file modes like 0o777."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(call_expression
  function: (scoped_identifier
    name: (identifier) @fn
  )
  arguments: (arguments
    (integer_literal) @perm
  )
  (#eq? @fn "set_mode")
  (#match? @perm "0o7")
) @call
'''

[[rules]]
id = "rust-weak-crypto"
name = "Weak Cryptographic Hash"
description = "MD5 and SHA1 are cryptographically weak"
severity = "Medium"
languages = ["Rust"]
cwe_ids = ["CWE-327", "CWE-328"]
owasp_categories = ["A02:2021 - Cryptographic Failures"]
tags = ["crypto", "weak-algorithm", "rust"]
message = "Use SHA-256 or stronger hash algorithms."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(use_declaration
  argument: (scoped_identifier) @import
  (#match? @import "(?i)(md5|sha1)")
) @use
'''

[[rules]]
id = "rust-static-mut"
name = "Static Mutable Variable"
description = "static mut can cause data races"
severity = "High"
languages = ["Rust"]
cwe_ids = ["CWE-362"]
owasp_categories = []
tags = ["concurrency", "data-race", "rust"]
message = "Use Mutex, RwLock, or atomic types instead of static mut."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(static_item
  (mutable_specifier) @mut
) @static
'''

[[rules]]
id = "rust-box-leak"
name = "Box::leak Memory Leak"
description = "Box::leak intentionally leaks memory"
severity = "Low"
languages = ["Rust"]
cwe_ids = ["CWE-401"]
owasp_categories = []
tags = ["memory", "leak", "rust"]
message = "Box::leak should only be used for truly static data. Consider Arc for shared ownership."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(call_expression
  function: (scoped_identifier
    path: (identifier) @type
    name: (identifier) @fn
  )
  (#eq? @type "Box")
  (#eq? @fn "leak")
) @call
'''

[[rules]]
id = "rust-format-sql"
name = "Format String SQL"
description = "Using format! for SQL queries can lead to SQL injection"
severity = "High"
languages = ["Rust"]
cwe_ids = ["CWE-89"]
owasp_categories = ["A03:2021 - Injection"]
tags = ["sql", "injection", "rust"]
message = "Use parameterized queries with sqlx::query! or diesel instead of format!."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(macro_invocation
  macro: (identifier) @macro
  (token_tree
    (string_literal) @sql
  )
  (#eq? @macro "format")
  (#match? @sql "(?i)(SELECT|INSERT|UPDATE|DELETE|WHERE)")
) @call
'''

[[rules]]
id = "rust-regex-user-input"
name = "User-Controlled Regex"
description = "Regex compiled from user input can cause ReDoS"
severity = "Medium"
languages = ["Rust"]
cwe_ids = ["CWE-1333", "CWE-400"]
owasp_categories = []
tags = ["redos", "regex", "rust"]
message = "Use Regex::new with size limits or fancy_regex with backtrack limits."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(call_expression
  function: (scoped_identifier
    path: (identifier) @type
    name: (identifier) @fn
  )
  (#eq? @type "Regex")
  (#eq? @fn "new")
) @call
'''

[[rules]]
id = "rust-debug-assert"
name = "Debug Assert in Security Code"
description = "debug_assert! is removed in release builds"
severity = "Low"
languages = ["Rust"]
cwe_ids = ["CWE-617"]
owasp_categories = []
tags = ["assert", "debug", "rust"]
message = "Use assert! for security-critical checks that must run in release builds."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(macro_invocation
  macro: (identifier) @macro
  (#match? @macro "^debug_assert")
) @call
'''

[[rules]]
id = "rust-forget"
name = "std::mem::forget"
description = "forget() prevents Drop from running, potentially leaking resources"
severity = "Low"
languages = ["Rust"]
cwe_ids = ["CWE-401"]
owasp_categories = []
tags = ["memory", "drop", "rust"]
message = "Use ManuallyDrop if you need to prevent Drop. Ensure resources are properly handled."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(call_expression
  function: (scoped_identifier
    name: (identifier) @fn
  )
  (#eq? @fn "forget")
) @call
'''
