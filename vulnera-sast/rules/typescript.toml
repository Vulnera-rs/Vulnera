# TypeScript security rules â€” 14 rules

[[rules]]
id = "ts-any-type"
name = "Any Type Usage"
description = "Using 'any' type bypasses TypeScript's type checking"
severity = "Low"
languages = ["TypeScript"]
cwe_ids = []
owasp_categories = []
tags = ["type-safety", "typescript"]
message = "Use specific types instead of 'any'. Consider 'unknown' for truly unknown types."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(type_annotation
  (predefined_type) @type
  (#eq? @type "any")
) @any
'''

[[rules]]
id = "ts-ignore"
name = "@ts-ignore Suppression"
description = "@ts-ignore suppresses TypeScript errors and may hide issues"
severity = "Low"
languages = ["TypeScript"]
cwe_ids = []
owasp_categories = []
tags = ["type-safety", "typescript"]
message = "Use @ts-expect-error instead of @ts-ignore for better error handling."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(comment) @comment
  (#match? @comment "@ts-ignore")
'''

[[rules]]
id = "ts-non-null-assertion"
name = "Non-Null Assertion"
description = "Non-null assertion (!) bypasses null checks and can cause runtime errors"
severity = "Low"
languages = ["TypeScript"]
cwe_ids = ["CWE-476"]
owasp_categories = []
tags = ["type-safety", "null-pointer", "typescript"]
message = "Use optional chaining (?.) or null checks instead of non-null assertion."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(non_null_expression) @assertion
'''

[[rules]]
id = "ts-type-assertion"
name = "Type Assertion"
description = "Type assertions bypass type checking and may cause runtime errors"
severity = "Low"
languages = ["TypeScript"]
cwe_ids = []
owasp_categories = []
tags = ["type-safety", "typescript"]
message = "Consider using type guards or proper type narrowing."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(as_expression) @assertion
'''

[[rules]]
id = "ts-eval"
name = "Eval Usage"
description = "eval() allows arbitrary code execution"
severity = "High"
languages = ["TypeScript"]
cwe_ids = ["CWE-94"]
owasp_categories = ["A03:2021 - Injection"]
tags = ["injection", "code-execution", "typescript"]
message = "Avoid using eval() with user-controlled input."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(call_expression
  function: (identifier) @fn
  (#eq? @fn "eval")
) @call
'''

[[rules]]
id = "ts-innerhtml"
name = "innerHTML XSS"
description = "Setting innerHTML can lead to XSS"
severity = "High"
languages = ["TypeScript"]
cwe_ids = ["CWE-79"]
owasp_categories = ["A03:2021 - Injection"]
tags = ["xss", "typescript"]
message = "Use textContent or Angular's DOM sanitizer."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(assignment_expression
  left: (member_expression
    property: (property_identifier) @prop
  )
  (#eq? @prop "innerHTML")
) @assign
'''

[[rules]]
id = "ts-child-process"
name = "Child Process Execution"
description = "Potential command injection via child_process"
severity = "High"
languages = ["TypeScript"]
cwe_ids = ["CWE-78"]
owasp_categories = ["A03:2021 - Injection"]
tags = ["injection", "command", "typescript"]
message = "Validate and sanitize command arguments."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
[
  (call_expression
    function: (member_expression
      property: (property_identifier) @fn
    )
    (#match? @fn "^(exec|execSync|spawn|spawnSync|execFile|execFileSync)$")
  ) @call
  (call_expression
    function: (identifier) @fn
    (#match? @fn "^(exec|execSync|spawn|spawnSync|execFile|execFileSync)$")
  ) @call
]
'''

[[rules]]
id = "ts-sql-injection"
name = "SQL Injection"
description = "SQL query built with string concatenation is vulnerable to injection"
severity = "Critical"
languages = ["TypeScript"]
cwe_ids = ["CWE-89"]
owasp_categories = ["A03:2021 - Injection"]
tags = ["sql", "injection", "typescript"]
message = "Use parameterized queries with proper binding."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
[
  (call_expression
    function: (member_expression
      property: (property_identifier) @fn
    )
    arguments: (arguments
      [(binary_expression) (template_string)]
    )
    (#match? @fn "^(query|execute|raw)$")
  ) @sql

  (lexical_declaration
    (variable_declarator
      name: (identifier) @var
      value: (template_string) @sql
    )
    (#match? @sql "(?i)\\b(select|insert|update|delete|drop)\\b")
  ) @sql

  (lexical_declaration
    (variable_declarator
      name: (identifier) @var
      value: (binary_expression
        left: (string) @sql_start
        operator: "+"
        right: (_) @rhs
      )
    )
    (#match? @sql_start "(?i)\\b(select|insert|update|delete|drop)\\b")
  ) @sql

  (assignment_expression
    left: (identifier) @var
    right: (template_string) @sql
    (#match? @sql "(?i)\\b(select|insert|update|delete|drop)\\b")
  ) @sql

  (assignment_expression
    left: (identifier) @var
    right: (binary_expression
      left: (string) @sql_start
      operator: "+"
      right: (_) @rhs
    )
    (#match? @sql_start "(?i)\\b(select|insert|update|delete|drop)\\b")
  ) @sql

  (return_statement
    (template_string) @sql
    (#match? @sql "(?i)\\b(select|insert|update|delete|drop)\\b")
  ) @sql

  (return_statement
    (binary_expression
      left: (string) @sql_start
      operator: "+"
      right: (_) @rhs
    )
    (#match? @sql_start "(?i)\\b(select|insert|update|delete|drop)\\b")
  ) @sql
]
'''

[[rules]]
id = "ts-nosql-injection"
name = "NoSQL Injection"
description = "Potential NoSQL injection via MongoDB query"
severity = "Critical"
languages = ["TypeScript"]
cwe_ids = ["CWE-943"]
owasp_categories = ["A03:2021 - Injection"]
tags = ["nosql", "mongodb", "typescript"]
message = "Validate and sanitize user input before using in MongoDB queries."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(call_expression
  function: (member_expression
    property: (property_identifier) @fn
  )
  (#match? @fn "^(find|findOne|updateOne|deleteOne)$")
) @call
'''

[[rules]]
id = "ts-jwt-verify"
name = "JWT Algorithm Not Specified"
description = "JWT verification without algorithm restriction"
severity = "High"
languages = ["TypeScript"]
cwe_ids = ["CWE-347"]
owasp_categories = ["A02:2021 - Cryptographic Failures"]
tags = ["jwt", "authentication", "typescript"]
message = "Always specify algorithms: {algorithms: ['HS256']}"

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(call_expression
  function: (member_expression
    property: (property_identifier) @fn
  )
  (#match? @fn "^(verify|decode)$")
) @call
'''

[[rules]]
id = "ts-prototype-pollution"
name = "Prototype Pollution"
description = "Object merge without filtering can lead to prototype pollution"
severity = "High"
languages = ["TypeScript"]
cwe_ids = ["CWE-1321"]
owasp_categories = ["A03:2021 - Injection"]
tags = ["prototype-pollution", "typescript"]
message = "Filter out __proto__, constructor, prototype before merging."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(call_expression
  function: (member_expression
    object: (identifier) @obj
    property: (property_identifier) @fn
  )
  (#eq? @obj "Object")
  (#eq? @fn "assign")
) @call
'''

[[rules]]
id = "ts-ssti"
name = "Server-Side Template Injection"
description = "Template engine may execute user input"
severity = "Critical"
languages = ["TypeScript"]
cwe_ids = ["CWE-94"]
owasp_categories = ["A03:2021 - Injection"]
tags = ["ssti", "injection", "typescript"]
message = "Never pass user input directly to template engines."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(call_expression
  function: (member_expression
    property: (property_identifier) @fn
  )
  (#match? @fn "^(compile|render|renderString)$")
) @call
'''

[[rules]]
id = "ts-cors-wildcard"
name = "CORS Wildcard Origin"
description = "CORS with wildcard origin exposes API"
severity = "Medium"
languages = ["TypeScript"]
cwe_ids = ["CWE-942"]
owasp_categories = ["A05:2021 - Security Misconfiguration"]
tags = ["cors", "misconfiguration", "typescript"]
message = "Specify allowed origins explicitly."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(object
  (pair
    key: (property_identifier) @key
    value: (string) @value
  )
  (#match? @key "(?i)origin")
  (#eq? @value "\"*\"")
) @cors
'''

[[rules]]
id = "ts-ssrf"
name = "Server-Side Request Forgery"
description = "HTTP request with user-controlled URL can lead to SSRF"
severity = "High"
languages = ["TypeScript"]
cwe_ids = ["CWE-918"]
owasp_categories = ["A10:2021 - Server-Side Request Forgery"]
tags = ["ssrf", "network", "typescript"]
message = "Validate and allowlist URLs before making requests."

[rules.pattern]
type = "TreeSitterQuery"
value = '''
(call_expression
  function: (identifier) @fn
  (#match? @fn "^(fetch|axios|got|request)$")
) @call
'''
